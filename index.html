<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>League XD</title>
    <link rel="stylesheet" href="css/style.css"/>

</head>
<body>
    <div>
        <h1 class="header" id="header"></h1>
    </div>
    <div id="container">

    </div>
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="header"><p id="game-info"></p><span class="close">&times;</span></div>
            <div id="container-modal">

            </div>
        </div>
    </div>
    <script src="js/participant.js"> </script>
    <script src="js/game.js"> </script>
    <script>
        let currentGameState = null;

        availableStates = {
            'None': 'Main Menu',
            'Lobby': 'Lobby',
            'Matchmaking': 'Looking for game',
            'ReadyCheck': 'Accepting',
            'ChampSelect': 'Champion Select',
            'InProgress': 'Waiting for game Result',
            'WaitingForStats': 'Waiting for Stats',
            'PreEndOfGame': 'Honor a Player',
            'EndOfGame': 'End Of Game',
        };

        function stateChanged(previous, current) {
            document.getElementById('header').innerHTML = availableStates[current];
            console.log('State change: ',previous, '=>', current);
            if(current === 'EndOfGame') {
                saveGame()
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('header').innerHTML = 'Game Saved';

                        fetchAndDisplayData();
                    })
            }
            if (current === 'ChampSelect') {
                showTeammates();
            }

            if (current === 'InProgress') {
                document.getElementById('container').innerHTML = '';
                showCurrentGame();
            }

            if (current === 'None' || current === 'Lobby') {
            }

            if (current === 'ReadyCheck') {
                acceptMatch();
            }

            if((current === 'None' || current === 'Lobby') && previous === null) {
                waitingForGame();
            }

        }

        const apiUrl = 'https://laptop.local';
        const clientUrl = 'http://192.168.0.106:3000';

        updateGameState();

        function acceptMatch() {
            fetch(`${clientUrl}/accept`)
                .then(res => res.json())
                .then(data => {
                    console.log('Game accepted');
                })
        }

        function updateGameState() {
            fetch(`${clientUrl}/game-state`)
                .then(res => res.json())
                .then(data => {

                    if (currentGameState !== data.game_state) {
                        stateChanged(currentGameState, data.game_state);
                        currentGameState = data.game_state;
                    }

                    setTimeout(() => {
                        updateGameState();
                    }, 2000)
                })

        }

        function waitingForGame() {
            document.getElementById('container').innerHTML = '';

            const divContainer = document.createElement('div');
            divContainer.classList.add('container-loader');

            const loader = document.createElement('div');
            loader.classList.add('loader');

            const h1 = document.createElement('h1');

            h1.innerHTML = 'Waiting For Game';

            divContainer.appendChild(loader);
            divContainer.appendChild(h1);

            document.getElementById('container').appendChild(divContainer);
        }

        function showTeammates() {
            setTimeout(() => {
                fetch(`${clientUrl}/participants`)
                    .then(res => res.json())
                    .then(data => {
                        displayChampionSelectPlayers(data);
                    })
            }, 1000)

        }

        async function saveGame() {
            return fetch(`${apiUrl}/game/save`)
        }

        function displayParticipants(participants) {
            container.classList.add('active-game-container')

            participants.forEach(participant => {
                let championName;

                if (!participant.champion_id) {
                    championName = '';
                } else {
                   championName = participant.champion_name ? participant.champion_name : getChampionById(participant.champion_id).id
                }

                container.appendChild(
                    (new Participant(
                        participant.summoner_name,
                        participant.games_played,
                        championName,
                        participant.url_opgg,
                        participant.team_id,
                        participant.summoner_id
                    )).getCard()
                );
            });
        }

        function displayChampionSelectPlayers(participants) {
            document.getElementById('container').innerHTML = '';

            let participantNames = [];

            participants['participants'].forEach(participant => {
                participantNames.push({summonerName: participant.name});
            });

            fetch(`${apiUrl}/summoners/championSelect`, {
                    method: 'POST',
                    body: JSON.stringify(participantNames)
                })
                .then(response => response.json())
                .then(data => {
                    const participants = data.info;

                    displayParticipants(participants);
                })
        }

        function fetchAndDisplayData() {
            const container = document.createElement('div');

            fetch(`${apiUrl}/game/last`)
                .then(response => response.json())
                .then(data => {
                    const participants = data.game.info.participants;

                    container.classList.add('cards-container')

                    participants.forEach(participant => {
                        if (!participant.champion_id) {
                            championName = '';
                        } else {
                            championName = participant.champion_name ? participant.champion_name : getChampionById(participant.champion_id).id
                        }

                        container.appendChild(
                            (new Participant(
                                participant.summoner_name,
                                participant.games_played,
                                championName,
                                participant.url_opgg,
                                participant.team_id,
                                participant.summoner_id,
                                participant.id,
                                participant.comment,
                            )).getCommentCard()
                        );
                    });

                    const submitButton = document.createElement('button');
                    submitButton.classList.add('save-comments');
                    submitButton.textContent = 'Save comments';

                    submitButton.addEventListener('click', async () => {
                        const inputs = document.querySelectorAll('input[type="text"]');

                        const data = [];
                        for (const input of inputs) {
                            data.push({
                                id: input.getAttribute('data-id'),
                                comment: input.value,
                            })
                        }

                        const response = await fetch(`${apiUrl}/game/save-result`, {
                            method: 'POST',
                            mode: 'no-cors', // no-cors, *cors, same-origin
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        waitingForGame();
                    });

                    document.getElementById('container').innerHTML = '';
                    document.getElementById('container').appendChild(submitButton);

                    document.getElementById('container').appendChild(container);
                });


        }

        let champions = [];

        function getChampionById(id) {
            if (id === null) {
                return 'none'
            }
            for(const champion in champions.data) {
                if (champions.data[`${champion}`].key === `${id}`) {
                    return champions.data[`${champion}`]
                }
            }
        }

        fetch('http://ddragon.leagueoflegends.com/cdn/13.1.1/data/en_US/champion.json')
            .then(response => response.json())
            .then(data => {
                champions = data;
            })


        function getGamesAsHTML(summonerId, container, label) {
            fetch(`${apiUrl}/summoner/${summonerId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(gameElement => {
                        container.appendChild(
                            (new Game(gameElement.info, gameElement.metadata)).getGameCard()
                        );
                    })
                    label.classList.toggle('active');

                })
        }

        const fieldsToDisplay = [
            'championName',
            'individualPosition',
            'summonerName',
            'pentaKills',
            'visionScore',
            'wardsPlaced',
            'comment'
        ];

        function showCurrentGame() {
            fetch(`${apiUrl}/game/active/SirDomin`)
                .then(response => response.json())
                .then(data => {
                    if (!data.info) {
                        console.log('no game');

                        return;
                    }

                    const participants = data.info;
                    displayParticipants(participants)

                })
        }

        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        function showGame(gameId) {
            const modalContainer = document.getElementById('container-modal');
            modalContainer.innerHTML = '';

            fetch(`${apiUrl}/game/by-puuid/${gameId}`)
                .then(res => res.json())
                .then(data => {
                    modal.style.display = "flex";
                    const date = new Date(parseInt(data.info.game_creation));
                    const formattedDate = date.toISOString().slice(0, 16).replace('T', ' ');

                    const winningTeam = data.info.teams[0].win ? 'Blue Team' : 'Red Team';

                    const headerInfo = document.getElementById('game-info');
                    headerInfo.innerHTML = `GAME: ${gameId} | ${formattedDate} | ( Duration ${fmtMSS(data.info.game_duration)} ) win: ${winningTeam} | MODE: ${data.info.game_mode}-${data.info.game_type}`
                    data.info.participants.forEach(participant => {
                        modalContainer.appendChild(
                            (new Participant()).getDetailedCard(participant)
                        );
                    })
                })
        }
        function fmtMSS(s){return(s-(s%=60))/60+(9<s?':':':0')+s}
    </script>
</body>
</html>