<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>League XD</title>
    <link rel="stylesheet" href="css/style.css"/>

</head>
<body>
    <div>
        <h1 class="header" id="header"></h1>
    </div>
    <div id="container">

    </div>
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="header"><p id="game-info"></p><span class="close">&times;</span></div>
            <div id="container-modal">

            </div>
        </div>
    </div>
    <script src="js/participant.js"> </script>
    <script src="js/game.js"> </script>
    <script src="js/stateDecider.js"> </script>
    <script src="js/apiManager.js"> </script>
    <script src="js/mocker.js"> </script>
    <script>
        const stateDecider = new StateDecider();
        const mocker = new Mocker();
        const apiManager = new ApiManager(mocker);
        stateDecider.onStateChange(StateDecider.ANY, StateDecider.END_OF_GAME, () => {
            apiManager.saveGame()
                .then(data => {
                    document.getElementById('header').innerHTML = 'Game Saved';

                    showPreviousGame();
                })

            document.getElementById('header').innerHTML = 'End of Game';
        });


        stateDecider.onStateChange(StateDecider.ANY, StateDecider.CHAMPION_SELECT, () => {
            showTeammates();

            document.getElementById('header').innerHTML = 'Champion Select';
        });

        stateDecider.onStateChange(StateDecider.ANY, StateDecider.IN_PROGRESS, () => {
            document.getElementById('container').innerHTML = '';
            document.getElementById('header').innerHTML = 'Game In progress';

            showCurrentGame();
        });

        stateDecider.onStateChange(StateDecider.NONE, StateDecider.MATCHMAKING, () => {})
        stateDecider.onStateChange(StateDecider.MATCHMAKING, StateDecider.READY_CHECK, () => {})
        stateDecider.onStateChange(StateDecider.READY_CHECK, StateDecider.IN_PROGRESS, () => {})
        stateDecider.onStateChange(StateDecider.IN_PROGRESS, StateDecider.PRE_END_OF_GAME, () => {})
        stateDecider.onStateChange(StateDecider.PRE_END_OF_GAME, StateDecider.END_OF_GAME, () => {})

        stateDecider.onStateChange(StateDecider.ANY, StateDecider.READY_CHECK, () => {
            apiManager.acceptMatch().then(data => {
                console.log('Match accepted');
            });

            document.getElementById('header').innerHTML = 'Accepting Match';
        });

        stateDecider.onStateChange([null, StateDecider.END_OF_GAME], [StateDecider.NONE, StateDecider.LOBBY, StateDecider.MATCHMAKING], () => {
            document.getElementById('header').innerHTML = 'Waiting for game to start';

            waitingForGame();
        });

        console.log(stateDecider.handlers);
        let currentGameState = null;

        stateDecider.stateChanged(StateDecider.NONE)

        availableStates = {
            'None': 'Main Menu',
            'Lobby': 'Lobby',
            'Matchmaking': 'Looking for game',
            'ReadyCheck': 'Accepting',
            'ChampSelect': 'Champion Select',
            'InProgress': 'Waiting for game Result',
            'WaitingForStats': 'Waiting for Stats',
            'PreEndOfGame': 'Honor a Player',
            'EndOfGame': 'End Of Game',
        };

        // updateGameState();

        function waitingForGame() {
            document.getElementById('container').innerHTML = '';

            const divContainer = document.createElement('div');
            divContainer.classList.add('container-loader');

            const loader = document.createElement('div');
            loader.classList.add('loader');

            const h1 = document.createElement('h1');

            h1.innerHTML = 'Waiting For Game';

            divContainer.appendChild(loader);
            divContainer.appendChild(h1);

            document.getElementById('container').appendChild(divContainer);
        }

        function showTeammates() {
            setTimeout(() => {
                this.apiManager.getChampionSelectPlayers().then(data => {
                    displayChampionSelectPlayers(data);
                })
            }, 3000)
        }

        function displayParticipants(participants) {
            container.classList.add('active-game-container')

            participants.forEach(participant => {
                let championName;

                if (!participant.champion_id) {
                    championName = '';
                } else {
                   championName = participant.champion_name ? participant.champion_name : getChampionById(participant.champion_id).id
                }

                container.appendChild(
                    (new Participant(
                        participant.summoner_name,
                        participant.games_played,
                        championName,
                        participant.url_opgg,
                        participant.team_id,
                        participant.summoner_id
                    )).getCard()
                );
            });
        }

        function displayChampionSelectPlayers(participants) {
            document.getElementById('container').innerHTML = '';

            let participantNames = [];

            participants['participants'].forEach(participant => {
                participantNames.push({summonerName: participant.name});
            });

            apiManager.getChampionSelectData(participantNames)
                .then(data => {
                    const participants = data.info;

                    displayParticipants(participants);
                })
        }

        function showPreviousGame() {
            const container = document.createElement('div');

            this.apiManager.getLastGameData()
                .then(data => {
                    const participants = data.game.info.participants;

                    container.classList.add('cards-container')

                    participants.forEach(participant => {
                        if (!participant.champion_id) {
                            championName = '';
                        } else {
                            championName = participant.champion_name ? participant.champion_name : getChampionById(participant.champion_id).id
                        }

                        container.appendChild(
                            (new Participant(
                                participant.summoner_name,
                                participant.games_played,
                                championName,
                                participant.url_opgg,
                                participant.team_id,
                                participant.summoner_id,
                                participant.id,
                                participant.comment,
                            )).getCommentCard()
                        );
                    });

                    const submitButton = document.createElement('button');
                    submitButton.classList.add('save-comments');
                    submitButton.textContent = 'Save comments';

                    submitButton.addEventListener('click', async () => {
                        const inputs = document.querySelectorAll('input[type="text"]');

                        const data = [];
                        for (const input of inputs) {
                            data.push({
                                id: input.getAttribute('data-id'),
                                comment: input.value,
                            })
                        }

                        await apiManager.saveGameData(data);

                        waitingForGame();
                    });

                    document.getElementById('container').innerHTML = '';
                    document.getElementById('container').appendChild(submitButton);

                    document.getElementById('container').appendChild(container);
                });


        }

        let champions = [];

        function getChampionById(id) {
            if (id === null) {
                return 'none'
            }
            for(const champion in champions.data) {
                if (champions.data[`${champion}`].key === `${id}`) {
                    return champions.data[`${champion}`]
                }
            }
        }

        apiManager.getChampions().then(data => {
            champions = data;
            console.log(champions);
        })

        function getGamesAsHTML(summonerId, container, label) {
            this.apiManager.getSummoner(summonerId)
                .then(data => {
                    data.forEach(gameElement => {
                        container.appendChild(
                            (new Game(gameElement.info, gameElement.metadata)).getGameCard()
                        );
                    })
                    label.classList.toggle('active');
                })
        }

        const fieldsToDisplay = [
            'championName',
            'individualPosition',
            'summonerName',
            'pentaKills',
            'visionScore',
            'wardsPlaced',
            'comment'
        ];

        function showCurrentGame() {
            this.apiManager.getActiveGame('SirDomin')
                .then(data => {
                    if (!data.info) {
                        console.log('no game');

                        return;
                    }

                    const participants = data.info;
                    displayParticipants(participants)

                })
        }

        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        function showGame(gameId) {
            const modalContainer = document.getElementById('container-modal');
            modalContainer.innerHTML = '';

            apiManager.getGameByPuuId(gameId)
                .then(data => {
                    modal.style.display = "flex";
                    const date = new Date(parseInt(data.info.game_creation));
                    const formattedDate = date.toISOString().slice(0, 16).replace('T', ' ');

                    const winningTeam = data.info.teams[0].win ? 'Blue Team' : 'Red Team';

                    const headerInfo = document.getElementById('game-info');
                    headerInfo.innerHTML = `GAME: ${gameId} | ${formattedDate} | ( Duration ${fmtMSS(data.info.game_duration)} ) win: ${winningTeam} | MODE: ${data.info.game_mode}-${data.info.game_type}`
                    data.info.participants.forEach(participant => {
                        modalContainer.appendChild(
                            (new Participant()).getDetailedCard(participant)
                        );
                    })
                })
        }
        function fmtMSS(s){return(s-(s%=60))/60+(9<s?':':':0')+s}
    </script>
</body>
</html>